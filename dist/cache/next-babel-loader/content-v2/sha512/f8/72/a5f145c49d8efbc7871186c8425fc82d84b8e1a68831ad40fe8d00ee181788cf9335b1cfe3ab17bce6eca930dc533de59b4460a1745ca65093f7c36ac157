{"ast":null,"code":"var _jsxFileName = \"C:\\\\Users\\\\didi\\\\Desktop\\\\frontend.ro\\\\client\\\\components\\\\SolveExercise\\\\SolveExercise.tsx\";\nvar __jsx = React.createElement;\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\nimport Link from 'next/link';\nimport React, { useState, useEffect, useRef } from 'react';\nimport { connect } from 'react-redux';\nimport Header from '~/components/Header';\nimport Footer from '~/components/Footer';\nimport Spinner from '~/components/Spinner';\nimport Markdown from '~/components/Markdown';\nimport { withAuthModal } from '~/services/Hooks';\nimport TableOfContents from '~/components/TableOfContents';\nimport PageContainer from '~/components/PageContainer';\nimport StatusBanner from './StatusBanner/StatusBanner';\nimport SubmissionService from '~/services/Submission.service';\nimport { SUBMISSION_STATUS } from '~/../shared/SharedConstants';\nimport LessonExerciseService from '~/services/LessonExercise.service';\nimport SweetAlertService from '~/services/sweet-alert/SweetAlert.service';\nimport PageWithAsideMenu from '~/components/layout/PageWithAsideMenu/PageWithAsideMenu';\nimport styles from './SolveExercise.module.scss';\nimport { getLessonById } from '~/services/Constants';\nimport CompleteEditorLazy from '../Editor/CompleteEditor/CompleteEditor.lazy';\nimport Button from '../Button';\n\nfunction SolveExercise({\n  exerciseId,\n  userInfo\n}) {\n  const solutionRef = useRef(null);\n  const {\n    0: submission,\n    1: setSubmission\n  } = useState(null);\n  const {\n    0: fetchError,\n    1: setFetchError\n  } = useState(false);\n  const {\n    0: isSubmitting,\n    1: setIsSubmitting\n  } = useState(false);\n  const {\n    0: lessonExercises,\n    1: setLessonExercises\n  } = useState([]);\n  const readonly = submission && (submission.status === SUBMISSION_STATUS.DONE || submission.status === SUBMISSION_STATUS.AWAITING_REVIEW);\n  const exerciseIndex = lessonExercises.findIndex(ex => {\n    var _submission$exercise;\n\n    return ex._id === (submission === null || submission === void 0 ? void 0 : (_submission$exercise = submission.exercise) === null || _submission$exercise === void 0 ? void 0 : _submission$exercise._id);\n  });\n  const folderStructure = React.useMemo(() => {\n    if (!submission) {\n      return null;\n    }\n\n    return JSON.parse(submission.code || submission.exercise.example);\n  }, [submission]);\n\n  const submitSolution = async () => {\n    const code = solutionRef.current.getFolderStructure();\n\n    if (!code) {\n      SweetAlertService.toast({\n        timer: 5000,\n        type: 'error',\n        text: 'Hmm, dacă nu introduci o soluție pe ce să-ți dăm feedback?'\n      });\n      return;\n    }\n\n    if (submission.feedbacks.length > 0) {\n      SweetAlertService.toast({\n        timer: 5000,\n        type: 'error',\n        text: 'Mai sunt câteva feedback-uri nerezolvate.'\n      });\n      return;\n    }\n\n    setIsSubmitting(true);\n    let updatedSubmission;\n\n    if (submission._id) {\n      updatedSubmission = await SubmissionService.updateSubmission(submission._id, {\n        status: SUBMISSION_STATUS.AWAITING_REVIEW,\n        code\n      });\n    } else {\n      updatedSubmission = await SubmissionService.submitSubmission(exerciseId, code);\n    }\n\n    setIsSubmitting(false);\n    setSubmission(updatedSubmission);\n    SweetAlertService.toast({\n      type: 'success',\n      text: 'Ai trimis soluția cu succes'\n    });\n  };\n\n  const exitReadonly = () => {\n    return SubmissionService.updateSubmission(submission._id, {\n      status: SUBMISSION_STATUS.IN_PROGRESS\n    }).then(setSubmission).catch(err => {\n      console.error('[exitReadonly]', err);\n      SweetAlertService.toast({\n        type: 'error',\n        text: 'Oops! Nu am putut să edităm acest exercițiu. Încearcă din nou!'\n      });\n    });\n  };\n\n  const fetchExercise = () => {\n    return LessonExerciseService.getLessonExercise(exerciseId).then(exercise => {\n      setSubmission({\n        user: null,\n        exercise,\n        code: null,\n        feedbacks: [],\n        assignee: null,\n        status: SUBMISSION_STATUS.IN_PROGRESS\n      });\n    }).catch(err => {\n      console.error('[fetchExercise]', err);\n      setFetchError(true);\n    });\n  };\n\n  const fetchSubmission = () => {\n    return SubmissionService.getOwnSubmission(exerciseId).then(submission => {\n      setSubmission(submission);\n    }).catch(err => {\n      if (err.code === 404) {\n        fetchExercise();\n        return;\n      }\n\n      console.error('[fetchSubmission]', err);\n      setFetchError(true);\n    });\n  };\n\n  const fetchExercisesFromLesson = lessonId => {\n    return LessonExerciseService.getAllExercisesForLessons(lessonId).then(lessonExercises => setLessonExercises(lessonExercises)).catch(err => {\n      // Do nothing since the default value is empty Array\n      // so the UI is non-breaking\n      console.error('[SolveExercise.fetchExercisesFromLesson]', err);\n    });\n  };\n\n  const onFeedbackDone = _id => {\n    console.log(_id, submission.feedbacks.filter(f => f._id !== _id));\n    setSubmission(_objectSpread(_objectSpread({}, submission), {}, {\n      feedbacks: submission.feedbacks.filter(f => f._id !== _id)\n    }));\n  };\n\n  useEffect(() => {\n    const isLoggedIn = !!userInfo;\n\n    if (isLoggedIn) {\n      fetchSubmission();\n    } else {\n      fetchExercise();\n    }\n  }, [exerciseId]);\n  useEffect(() => {\n    if (submission) {\n      fetchExercisesFromLesson(submission.exercise.lesson);\n    }\n  }, [submission]);\n\n  if (fetchError) {\n    return __jsx(React.Fragment, null, __jsx(Header, {\n      withNavMenu: true,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 198,\n        columnNumber: 9\n      }\n    }), __jsx(PageContainer, {\n      className: \"text-center\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 199,\n        columnNumber: 9\n      }\n    }, __jsx(\"h1\", {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 200,\n        columnNumber: 11\n      }\n    }, \" Oops \\uD83D\\uDE1F\"), __jsx(\"h2\", {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 201,\n        columnNumber: 11\n      }\n    }, \" Exerci\\u021Biul e privat sau nu exist\\u0103 \"), __jsx(Link, {\n      href: \"/\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 203,\n        columnNumber: 11\n      }\n    }, __jsx(\"a\", {\n      className: \"btn btn--blue\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 204,\n        columnNumber: 13\n      }\n    }, \"Navigheaz\\u0103 acas\\u0103\"))), __jsx(Footer, {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 209,\n        columnNumber: 9\n      }\n    }));\n  }\n\n  if (!submission) {\n    return __jsx(PageContainer, {\n      className: \"relative\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 215,\n        columnNumber: 7\n      }\n    }, __jsx(Spinner, {\n      showText: true,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 216,\n        columnNumber: 9\n      }\n    }));\n  }\n\n  return __jsx(PageWithAsideMenu, {\n    menu: {\n      title: getLessonById(submission.exercise.lesson).title,\n      Component: __jsx(TableOfContents, {\n        chapters: lessonExercises.map((lessonEx, index) => ({\n          id: lessonEx._id,\n          title: `Exercițiu #${index + 1}`,\n          href: `/rezolva/${lessonEx._id}`\n        })),\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 225,\n          columnNumber: 9\n        }\n      })\n    },\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 222,\n      columnNumber: 5\n    }\n  }, readonly && __jsx(StatusBanner, {\n    status: submission.status,\n    onExitReadonly: exitReadonly,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 236,\n      columnNumber: 9\n    }\n  }), __jsx(PageContainer, {\n    className: \"relative\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 241,\n      columnNumber: 7\n    }\n  }, __jsx(\"h1\", {\n    className: \"mb-0\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 242,\n      columnNumber: 9\n    }\n  }, \"Exerci\\u021Biu\", ' ', submission.exercise.type.toUpperCase()), __jsx(\"p\", {\n    className: \"m-0\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 247,\n      columnNumber: 9\n    }\n  }, \"Creat de\", ' ', __jsx(Link, {\n    href: `/${submission.exercise.user.username}`,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 250,\n      columnNumber: 11\n    }\n  }, __jsx(\"a\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 251,\n      columnNumber: 13\n    }\n  }, submission.exercise.user.name || submission.exercise.user.username))), __jsx(Markdown, {\n    markdownString: submission.exercise.body,\n    className: styles.bodyMarkdown,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 257,\n      columnNumber: 9\n    }\n  }), __jsx(\"section\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 258,\n      columnNumber: 9\n    }\n  }, __jsx(\"h2\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 259,\n      columnNumber: 11\n    }\n  }, \" Rezolv\\u0103 exerci\\u021Biul \"), __jsx(CompleteEditorLazy, {\n    readOnly: readonly,\n    key: exerciseId,\n    ref: solutionRef,\n    askTooltip: false,\n    onFeedbackDone: onFeedbackDone,\n    feedbacks: submission.feedbacks,\n    folderStructure: folderStructure,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 260,\n      columnNumber: 11\n    }\n  })), __jsx(\"section\", {\n    className: \"my-5 d-flex align-items-center justify-content-between\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 270,\n      columnNumber: 9\n    }\n  }, __jsx(Button, {\n    disabled: readonly,\n    loading: isSubmitting,\n    variant: \"success\",\n    onClick: withAuthModal(!!userInfo, submitSolution),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 271,\n      columnNumber: 11\n    }\n  }, userInfo ? 'Trimite' : 'Autentifică-te și trimite soluția'), submission.status !== SUBMISSION_STATUS.IN_PROGRESS && exerciseIndex + 1 < lessonExercises.length && __jsx(Link, {\n    href: `/rezolva/${lessonExercises[exerciseIndex + 1]._id}`,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 282,\n      columnNumber: 15\n    }\n  }, __jsx(\"a\", {\n    className: \"btn btn--default no-underline\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 283,\n      columnNumber: 17\n    }\n  }, \"Rezolv\\u0103 urm\\u0103torul exerci\\u021Biu!\")))));\n}\n\nfunction mapStateToProps(state) {\n  return {\n    userInfo: state.user.info\n  };\n}\n\nconst connector = connect(mapStateToProps);\nexport default connector(SolveExercise);","map":{"version":3,"sources":["C:/Users/didi/Desktop/frontend.ro/client/components/SolveExercise/SolveExercise.tsx"],"names":["Link","React","useState","useEffect","useRef","connect","Header","Footer","Spinner","Markdown","withAuthModal","TableOfContents","PageContainer","StatusBanner","SubmissionService","SUBMISSION_STATUS","LessonExerciseService","SweetAlertService","PageWithAsideMenu","styles","getLessonById","CompleteEditorLazy","Button","SolveExercise","exerciseId","userInfo","solutionRef","submission","setSubmission","fetchError","setFetchError","isSubmitting","setIsSubmitting","lessonExercises","setLessonExercises","readonly","status","DONE","AWAITING_REVIEW","exerciseIndex","findIndex","ex","_id","exercise","folderStructure","useMemo","JSON","parse","code","example","submitSolution","current","getFolderStructure","toast","timer","type","text","feedbacks","length","updatedSubmission","updateSubmission","submitSubmission","exitReadonly","IN_PROGRESS","then","catch","err","console","error","fetchExercise","getLessonExercise","user","assignee","fetchSubmission","getOwnSubmission","fetchExercisesFromLesson","lessonId","getAllExercisesForLessons","onFeedbackDone","log","filter","f","isLoggedIn","lesson","title","Component","map","lessonEx","index","id","href","toUpperCase","username","name","body","bodyMarkdown","mapStateToProps","state","info","connector"],"mappings":"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","sourcesContent":["import Link from 'next/link';\r\nimport React, { useState, useEffect, useRef } from 'react';\r\nimport { connect, ConnectedProps } from 'react-redux';\r\n\r\nimport Header from '~/components/Header';\r\nimport Footer from '~/components/Footer';\r\nimport Spinner from '~/components/Spinner';\r\nimport Markdown from '~/components/Markdown';\r\nimport { RootState } from '~/redux/root.reducer';\r\nimport { withAuthModal } from '~/services/Hooks';\r\nimport TableOfContents from '~/components/TableOfContents';\r\nimport PageContainer from '~/components/PageContainer';\r\nimport StatusBanner from './StatusBanner/StatusBanner';\r\nimport SubmissionService from '~/services/Submission.service';\r\nimport { UserState, LessonExercise } from '~/redux/user/types';\r\nimport { SUBMISSION_STATUS } from '~/../shared/SharedConstants';\r\nimport LessonExerciseService from '~/services/LessonExercise.service';\r\nimport SweetAlertService from '~/services/sweet-alert/SweetAlert.service';\r\nimport PageWithAsideMenu from '~/components/layout/PageWithAsideMenu/PageWithAsideMenu';\r\n\r\nimport styles from './SolveExercise.module.scss';\r\nimport { getLessonById } from '~/services/Constants';\r\nimport CompleteEditorLazy from '../Editor/CompleteEditor/CompleteEditor.lazy';\r\nimport Feedbacks from '../Editor/Feedbacks';\r\nimport Button from '../Button';\r\n\r\ninterface Props {\r\n  exerciseId: string;\r\n}\r\n\r\ninterface Submission {\r\n  _id?: string;\r\n  user: UserState['info'];\r\n  exercise: LessonExercise;\r\n  code: string;\r\n  assignee: UserState['info'];\r\n  status: string;\r\n  feedbacks: {\r\n    _id: string;\r\n    type: string;\r\n    body: string;\r\n  }[]\r\n}\r\n\r\nfunction SolveExercise({ exerciseId, userInfo }: ConnectedProps<typeof connector> & Props) {\r\n  const solutionRef = useRef(null);\r\n  const [submission, setSubmission] = useState<Submission>(null);\r\n  const [fetchError, setFetchError] = useState(false);\r\n  const [isSubmitting, setIsSubmitting] = useState(false);\r\n  const [lessonExercises, setLessonExercises] = useState<LessonExercise[]>([]);\r\n\r\n  const readonly = submission && (\r\n    submission.status === SUBMISSION_STATUS.DONE\r\n    || submission.status === SUBMISSION_STATUS.AWAITING_REVIEW\r\n  );\r\n\r\n  const exerciseIndex = lessonExercises.findIndex((ex) => {\r\n    return ex._id === submission?.exercise?._id;\r\n  });\r\n\r\n  const folderStructure = React.useMemo(() => {\r\n    if (!submission) {\r\n      return null;\r\n    }\r\n\r\n    return JSON.parse(submission.code || submission.exercise.example);\r\n  }, [submission]);\r\n\r\n  const submitSolution = async () => {\r\n    const code = solutionRef.current.getFolderStructure();\r\n\r\n    if (!code) {\r\n      SweetAlertService.toast({\r\n        timer: 5000,\r\n        type: 'error',\r\n        text: 'Hmm, dacă nu introduci o soluție pe ce să-ți dăm feedback?',\r\n      });\r\n      return;\r\n    }\r\n\r\n    if (submission.feedbacks.length > 0) {\r\n      SweetAlertService.toast({\r\n        timer: 5000,\r\n        type: 'error',\r\n        text: 'Mai sunt câteva feedback-uri nerezolvate.',\r\n      });\r\n      return;\r\n    }\r\n\r\n    setIsSubmitting(true);\r\n\r\n    let updatedSubmission;\r\n    if (submission._id) {\r\n      updatedSubmission = await SubmissionService.updateSubmission(submission._id, {\r\n        status: SUBMISSION_STATUS.AWAITING_REVIEW,\r\n        code,\r\n      });\r\n    } else {\r\n      updatedSubmission = await SubmissionService.submitSubmission(exerciseId, code);\r\n    }\r\n\r\n    setIsSubmitting(false);\r\n    setSubmission(updatedSubmission);\r\n\r\n    SweetAlertService.toast({\r\n      type: 'success',\r\n      text: 'Ai trimis soluția cu succes',\r\n    });\r\n  };\r\n\r\n  const exitReadonly = () => {\r\n    return SubmissionService.updateSubmission(submission._id, {\r\n      status: SUBMISSION_STATUS.IN_PROGRESS,\r\n    })\r\n      .then(setSubmission)\r\n      .catch((err) => {\r\n        console.error('[exitReadonly]', err);\r\n        SweetAlertService.toast({\r\n          type: 'error',\r\n          text: 'Oops! Nu am putut să edităm acest exercițiu. Încearcă din nou!',\r\n        });\r\n      });\r\n  };\r\n\r\n  const fetchExercise = () => {\r\n    return LessonExerciseService\r\n      .getLessonExercise(exerciseId)\r\n      .then((exercise) => {\r\n        setSubmission({\r\n          user: null,\r\n          exercise,\r\n          code: null,\r\n          feedbacks: [],\r\n          assignee: null,\r\n          status: SUBMISSION_STATUS.IN_PROGRESS,\r\n        });\r\n      })\r\n      .catch((err) => {\r\n        console.error('[fetchExercise]', err);\r\n        setFetchError(true);\r\n      });\r\n  };\r\n\r\n  const fetchSubmission = () => {\r\n    return SubmissionService\r\n      .getOwnSubmission(exerciseId)\r\n      .then((submission) => {\r\n        setSubmission(submission);\r\n      })\r\n      .catch((err) => {\r\n        if (err.code === 404) {\r\n          fetchExercise();\r\n          return;\r\n        }\r\n        console.error('[fetchSubmission]', err);\r\n        setFetchError(true);\r\n      });\r\n  };\r\n\r\n  const fetchExercisesFromLesson = (lessonId) => {\r\n    return LessonExerciseService\r\n      .getAllExercisesForLessons(lessonId)\r\n      .then((lessonExercises) => setLessonExercises(lessonExercises))\r\n      .catch((err) => {\r\n        // Do nothing since the default value is empty Array\r\n        // so the UI is non-breaking\r\n        console.error('[SolveExercise.fetchExercisesFromLesson]', err);\r\n      });\r\n  };\r\n\r\n  const onFeedbackDone = (_id: string) => {\r\n    console.log(_id, submission.feedbacks.filter((f) => f._id !== _id));\r\n    setSubmission({\r\n      ...submission,\r\n      feedbacks: submission.feedbacks.filter((f) => f._id !== _id),\r\n    });\r\n  };\r\n\r\n  useEffect(() => {\r\n    const isLoggedIn = !!userInfo;\r\n\r\n    if (isLoggedIn) {\r\n      fetchSubmission();\r\n    } else {\r\n      fetchExercise();\r\n    }\r\n  }, [exerciseId]);\r\n\r\n  useEffect(() => {\r\n    if (submission) {\r\n      fetchExercisesFromLesson(submission.exercise.lesson);\r\n    }\r\n  }, [submission]);\r\n\r\n  if (fetchError) {\r\n    return (\r\n      <>\r\n        <Header withNavMenu />\r\n        <PageContainer className=\"text-center\">\r\n          <h1> Oops 😟</h1>\r\n          <h2> Exercițiul e privat sau nu există </h2>\r\n\r\n          <Link href=\"/\">\r\n            <a className=\"btn btn--blue\">\r\n              Navighează acasă\r\n            </a>\r\n          </Link>\r\n        </PageContainer>\r\n        <Footer />\r\n      </>\r\n    );\r\n  }\r\n  if (!submission) {\r\n    return (\r\n      <PageContainer className=\"relative\">\r\n        <Spinner showText />\r\n      </PageContainer>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <PageWithAsideMenu menu={{\r\n      title: getLessonById(submission.exercise.lesson).title,\r\n      Component: (\r\n        <TableOfContents\r\n          chapters={lessonExercises.map((lessonEx, index) => ({\r\n            id: lessonEx._id,\r\n            title: `Exercițiu #${index + 1}`,\r\n            href: `/rezolva/${lessonEx._id}`,\r\n          }))}\r\n        />\r\n      ),\r\n    }}\r\n    >\r\n      {readonly && (\r\n        <StatusBanner\r\n          status={submission.status}\r\n          onExitReadonly={exitReadonly}\r\n        />\r\n      )}\r\n      <PageContainer className=\"relative\">\r\n        <h1 className=\"mb-0\">\r\n          Exercițiu\r\n          {' '}\r\n          {submission.exercise.type.toUpperCase()}\r\n        </h1>\r\n        <p className=\"m-0\">\r\n          Creat de\r\n          {' '}\r\n          <Link href={`/${submission.exercise.user.username}`}>\r\n            <a>\r\n              {submission.exercise.user.name || submission.exercise.user.username}\r\n            </a>\r\n          </Link>\r\n\r\n        </p>\r\n        <Markdown markdownString={submission.exercise.body} className={styles.bodyMarkdown} />\r\n        <section>\r\n          <h2> Rezolvă exercițiul </h2>\r\n          <CompleteEditorLazy\r\n            readOnly={readonly}\r\n            key={exerciseId}\r\n            ref={solutionRef}\r\n            askTooltip={false}\r\n            onFeedbackDone={onFeedbackDone}\r\n            feedbacks={submission.feedbacks}\r\n            folderStructure={folderStructure}\r\n          />\r\n        </section>\r\n        <section className=\"my-5 d-flex align-items-center justify-content-between\">\r\n          <Button\r\n            disabled={readonly}\r\n            loading={isSubmitting}\r\n            variant=\"success\"\r\n            onClick={withAuthModal(!!userInfo, submitSolution)}\r\n          >\r\n            {userInfo ? 'Trimite' : 'Autentifică-te și trimite soluția'}\r\n          </Button>\r\n          {\r\n            (submission.status !== SUBMISSION_STATUS.IN_PROGRESS)\r\n            && (exerciseIndex + 1 < lessonExercises.length) && (\r\n              <Link href={`/rezolva/${lessonExercises[exerciseIndex + 1]._id}`}>\r\n                <a className=\"btn btn--default no-underline\">\r\n                  Rezolvă următorul exercițiu!\r\n                </a>\r\n              </Link>\r\n            )\r\n          }\r\n        </section>\r\n      </PageContainer>\r\n    </PageWithAsideMenu>\r\n  );\r\n}\r\n\r\nfunction mapStateToProps(state: RootState) {\r\n  return {\r\n    userInfo: state.user.info,\r\n  };\r\n}\r\n\r\nconst connector = connect(mapStateToProps);\r\n\r\nexport default connector(SolveExercise);\r\n"]},"metadata":{},"sourceType":"module"}