{"version":3,"sources":["../../../../../../build/webpack/config/blocks/css/index.ts"],"names":["regexLikeCss","regexCssGlobal","regexCssModules","regexSassGlobal","regexSassModules","css","ctx","config","prependData","sassPrependData","additionalData","sassAdditionalData","sassOptions","sassPreprocessors","loader","require","resolve","options","sourceMap","fns","oneOf","test","__next_css_remove","postCssPlugins","rootDirectory","isProduction","push","issuer","use","reason","sideEffects","and","not","isServer","include","customAppFile","path","relative","isClient","exclude","name","MiniCssExtractPlugin","filename","chunkFilename","ignoreOrder","fn"],"mappings":"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","sourcesContent":["import curry from 'next/dist/compiled/lodash.curry'\nimport path from 'path'\nimport webpack, { Configuration } from 'webpack'\nimport MiniCssExtractPlugin from '../../../plugins/mini-css-extract-plugin'\nimport { loader, plugin } from '../../helpers'\nimport { ConfigurationContext, ConfigurationFn, pipe } from '../../utils'\nimport { getCssModuleLoader, getGlobalCssLoader } from './loaders'\nimport {\n  getCustomDocumentError,\n  getGlobalImportError,\n  getGlobalModuleImportError,\n  getLocalModuleImportError,\n} from './messages'\nimport { getPostCssPlugins } from './plugins'\n\n// RegExps for all Style Sheet variants\nconst regexLikeCss = /\\.(css|scss|sass)$/\n\n// RegExps for Style Sheets\nconst regexCssGlobal = /(?<!\\.module)\\.css$/\nconst regexCssModules = /\\.module\\.css$/\n\n// RegExps for Syntactically Awesome Style Sheets\nconst regexSassGlobal = /(?<!\\.module)\\.(scss|sass)$/\nconst regexSassModules = /\\.module\\.(scss|sass)$/\n\nexport const css = curry(async function css(\n  ctx: ConfigurationContext,\n  config: Configuration\n) {\n  const {\n    prependData: sassPrependData,\n    additionalData: sassAdditionalData,\n    ...sassOptions\n  } = ctx.sassOptions\n\n  const sassPreprocessors: webpack.RuleSetUseItem[] = [\n    // First, process files with `sass-loader`: this inlines content, and\n    // compiles away the proprietary syntax.\n    {\n      loader: require.resolve('sass-loader'),\n      options: {\n        // Source maps are required so that `resolve-url-loader` can locate\n        // files original to their source directory.\n        sourceMap: true,\n        sassOptions,\n        additionalData: sassPrependData || sassAdditionalData,\n      },\n    },\n    // Then, `sass-loader` will have passed-through CSS imports as-is instead\n    // of inlining them. Because they were inlined, the paths are no longer\n    // correct.\n    // To fix this, we use `resolve-url-loader` to rewrite the CSS\n    // imports to real file paths.\n    {\n      loader: require.resolve('resolve-url-loader'),\n      options: {\n        // Source maps are not required here, but we may as well emit\n        // them.\n        sourceMap: true,\n      },\n    },\n  ]\n\n  const fns: ConfigurationFn[] = [\n    loader({\n      oneOf: [\n        {\n          // Impossible regex expression\n          test: /a^/,\n          loader: 'noop-loader',\n          options: { __next_css_remove: true },\n        },\n      ],\n    }),\n  ]\n\n  const postCssPlugins = await getPostCssPlugins(\n    ctx.rootDirectory,\n    ctx.isProduction,\n    // TODO: In the future, we should stop supporting old CSS setups and\n    // unconditionally inject ours. When that happens, we should remove this\n    // function argument.\n    true\n  )\n\n  // CSS cannot be imported in _document. This comes before everything because\n  // global CSS nor CSS modules work in said file.\n  fns.push(\n    loader({\n      oneOf: [\n        {\n          test: regexLikeCss,\n          // Use a loose regex so we don't have to crawl the file system to\n          // find the real file name (if present).\n          issuer: /pages[\\\\/]_document\\./,\n          use: {\n            loader: 'error-loader',\n            options: {\n              reason: getCustomDocumentError(),\n            },\n          },\n        },\n      ],\n    })\n  )\n\n  // CSS Modules support must be enabled on the server and client so the class\n  // names are available for SSR or Prerendering.\n  fns.push(\n    loader({\n      oneOf: [\n        {\n          // CSS Modules should never have side effects. This setting will\n          // allow unused CSS to be removed from the production build.\n          // We ensure this by disallowing `:global()` CSS at the top-level\n          // via the `pure` mode in `css-loader`.\n          sideEffects: false,\n          // CSS Modules are activated via this specific extension.\n          test: regexCssModules,\n          // CSS Modules are only supported in the user's application. We're\n          // not yet allowing CSS imports _within_ `node_modules`.\n          issuer: {\n            and: [ctx.rootDirectory],\n            not: [/node_modules/],\n          },\n          use: getCssModuleLoader(ctx, postCssPlugins),\n        },\n      ],\n    })\n  )\n  fns.push(\n    loader({\n      oneOf: [\n        // Opt-in support for Sass (using .scss or .sass extensions).\n        {\n          // Sass Modules should never have side effects. This setting will\n          // allow unused Sass to be removed from the production build.\n          // We ensure this by disallowing `:global()` Sass at the top-level\n          // via the `pure` mode in `css-loader`.\n          sideEffects: false,\n          // Sass Modules are activated via this specific extension.\n          test: regexSassModules,\n          // Sass Modules are only supported in the user's application. We're\n          // not yet allowing Sass imports _within_ `node_modules`.\n          issuer: {\n            and: [ctx.rootDirectory],\n            not: [/node_modules/],\n          },\n          use: getCssModuleLoader(ctx, postCssPlugins, sassPreprocessors),\n        },\n      ],\n    })\n  )\n\n  // Throw an error for CSS Modules used outside their supported scope\n  fns.push(\n    loader({\n      oneOf: [\n        {\n          test: [regexCssModules, regexSassModules],\n          use: {\n            loader: 'error-loader',\n            options: {\n              reason: getLocalModuleImportError(),\n            },\n          },\n        },\n      ],\n    })\n  )\n\n  if (ctx.isServer) {\n    fns.push(\n      loader({\n        oneOf: [\n          {\n            test: [regexCssGlobal, regexSassGlobal],\n            use: require.resolve('next/dist/compiled/ignore-loader'),\n          },\n        ],\n      })\n    )\n  } else {\n    fns.push(\n      loader({\n        oneOf: [\n          {\n            // A global CSS import always has side effects. Webpack will tree\n            // shake the CSS without this option if the issuer claims to have\n            // no side-effects.\n            // See https://github.com/webpack/webpack/issues/6571\n            sideEffects: true,\n            test: regexCssGlobal,\n            // We only allow Global CSS to be imported anywhere in the\n            // application if it comes from node_modules. This is a best-effort\n            // heuristic that makes a safety trade-off for better\n            // interoperability with npm packages that require CSS. Without\n            // this ability, the component's CSS would have to be included for\n            // the entire app instead of specific page where it's required.\n            include: { and: [/node_modules/] },\n            // Global CSS is only supported in the user's application, not in\n            // node_modules.\n            issuer: {\n              and: [ctx.rootDirectory],\n              not: [/node_modules/],\n            },\n            use: getGlobalCssLoader(ctx, postCssPlugins),\n          },\n        ],\n      })\n    )\n\n    if (ctx.customAppFile) {\n      fns.push(\n        loader({\n          oneOf: [\n            {\n              // A global CSS import always has side effects. Webpack will tree\n              // shake the CSS without this option if the issuer claims to have\n              // no side-effects.\n              // See https://github.com/webpack/webpack/issues/6571\n              sideEffects: true,\n              test: regexCssGlobal,\n              issuer: { and: [ctx.customAppFile] },\n              use: getGlobalCssLoader(ctx, postCssPlugins),\n            },\n          ],\n        })\n      )\n      fns.push(\n        loader({\n          oneOf: [\n            {\n              // A global Sass import always has side effects. Webpack will tree\n              // shake the Sass without this option if the issuer claims to have\n              // no side-effects.\n              // See https://github.com/webpack/webpack/issues/6571\n              sideEffects: true,\n              test: regexSassGlobal,\n              issuer: { and: [ctx.customAppFile] },\n              use: getGlobalCssLoader(ctx, postCssPlugins, sassPreprocessors),\n            },\n          ],\n        })\n      )\n    }\n  }\n\n  // Throw an error for Global CSS used inside of `node_modules`\n  fns.push(\n    loader({\n      oneOf: [\n        {\n          test: [regexCssGlobal, regexSassGlobal],\n          issuer: { and: [/node_modules/] },\n          use: {\n            loader: 'error-loader',\n            options: {\n              reason: getGlobalModuleImportError(),\n            },\n          },\n        },\n      ],\n    })\n  )\n\n  // Throw an error for Global CSS used outside of our custom <App> file\n  fns.push(\n    loader({\n      oneOf: [\n        {\n          test: [regexCssGlobal, regexSassGlobal],\n          use: {\n            loader: 'error-loader',\n            options: {\n              reason: getGlobalImportError(\n                ctx.customAppFile &&\n                  path.relative(ctx.rootDirectory, ctx.customAppFile)\n              ),\n            },\n          },\n        },\n      ],\n    })\n  )\n\n  if (ctx.isClient) {\n    // Automatically transform references to files (i.e. url()) into URLs\n    // e.g. url(./logo.svg)\n    fns.push(\n      loader({\n        oneOf: [\n          {\n            // This should only be applied to CSS files\n            issuer: regexLikeCss,\n            // Exclude extensions that webpack handles by default\n            exclude: [/\\.(js|mjs|jsx|ts|tsx)$/, /\\.html$/, /\\.json$/],\n            use: {\n              // `file-loader` always emits a URL reference, where `url-loader`\n              // might inline the asset as a data URI\n              loader: require.resolve('next/dist/compiled/file-loader'),\n              options: {\n                // Hash the file for immutable cacheability\n                name: 'static/media/[name].[hash].[ext]',\n              },\n            },\n          },\n        ],\n      })\n    )\n  }\n\n  if (ctx.isClient && ctx.isProduction) {\n    // Extract CSS as CSS file(s) in the client-side production bundle.\n    fns.push(\n      plugin(\n        // @ts-ignore webpack 5 compat\n        new MiniCssExtractPlugin({\n          filename: 'static/css/[contenthash].css',\n          chunkFilename: 'static/css/[contenthash].css',\n          // Next.js guarantees that CSS order \"doesn't matter\", due to imposed\n          // restrictions:\n          // 1. Global CSS can only be defined in a single entrypoint (_app)\n          // 2. CSS Modules generate scoped class names by default and cannot\n          //    include Global CSS (:global() selector).\n          //\n          // While not a perfect guarantee (e.g. liberal use of `:global()`\n          // selector), this assumption is required to code-split CSS.\n          //\n          // If this warning were to trigger, it'd be unactionable by the user,\n          // but likely not valid -- so we disable it.\n          ignoreOrder: true,\n        })\n      )\n    )\n  }\n\n  const fn = pipe(...fns)\n  return fn(config)\n})\n"]}