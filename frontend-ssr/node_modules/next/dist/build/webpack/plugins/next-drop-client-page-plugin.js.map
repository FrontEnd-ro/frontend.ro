{"version":3,"sources":["../../../../build/webpack/plugins/next-drop-client-page-plugin.ts"],"names":["isWebpack5","parseInt","version","ampFirstEntryNamesMap","WeakMap","PLUGIN_NAME","DropClientPage","ampPages","Set","apply","compiler","hooks","compilation","tap","normalModuleFactory","findEntryModule","mod","queue","module","incomingConnections","moduleGraph","getIncomingConnections","incomingConnection","originModule","add","reason","reasons","handler","parser","markAsAmpFirst","entryModule","state","buildInfo","NEXT_ampFirst","preDeclarator","declarator","id","name","STRING_LITERAL_DROP_BUNDLE","varDeclaration","for","has","set","ampFirstEntryNamesItem","get","seal","entryData","entries","dependency","dependencies","getModule","push","delete","i","_preparedEntrypoints","length","entrypoint","splice"],"mappings":"iGAAA,gCAMA,6DAEA,KAAMA,CAAAA,UAAU,CAAGC,QAAQ,CAACC,gBAAD,CAAR,GAAuB,CAA1C,CAEO,KAAMC,CAAAA,qBAGZ,CAAG,GAAIC,CAAAA,OAAJ,EAHG,C,oDAKP,KAAMC,CAAAA,WAAW,CAAG,yBAApB,CAEA;AACO,KAAMC,CAAAA,cAAiC,oBAC5CC,QAD4C,CACjC,GAAIC,CAAAA,GAAJ,EADiC,EAG5CC,KAAK,CAACC,QAAD,CAAqB,CACxBA,QAAQ,CAACC,KAAT,CAAeC,WAAf,CAA2BC,GAA3B,CACER,WADF,CAEE,CAACO,WAAD,CAAmB,CAAEE,mBAAF,CAAnB,GAAoD,CAClD;AACA,QAASC,CAAAA,eAAT,CAAyBC,GAAzB,CAAkE,CAChE,KAAMC,CAAAA,KAAK,CAAG,GAAIT,CAAAA,GAAJ,CAAQ,CAACQ,GAAD,CAAR,CAAd,CACA,IAAK,KAAME,CAAAA,MAAX,GAAqBD,CAAAA,KAArB,CAA4B,CAC1B,GAAIjB,UAAJ,CAAgB,CACd;AACA,KAAMmB,CAAAA,mBAAmB,CAAGP,WAAW,CAACQ,WAAZ,CAAwBC,sBAAxB,CAC1BH,MAD0B,CAA5B,CAIA,IAAK,KAAMI,CAAAA,kBAAX,GAAiCH,CAAAA,mBAAjC,CAAsD,CACpD,GAAI,CAACG,kBAAkB,CAACC,YAAxB,CAAsC,MAAOL,CAAAA,MAAP,CACtCD,KAAK,CAACO,GAAN,CAAUF,kBAAkB,CAACC,YAA7B,EACD,CACD,SACD,CAED,IAAK,KAAME,CAAAA,MAAX,GAAqBP,CAAAA,MAAM,CAACQ,OAA5B,CAAqC,CACnC,GAAI,CAACD,MAAM,CAACP,MAAZ,CAAoB,MAAOA,CAAAA,MAAP,CACpBD,KAAK,CAACO,GAAN,CAAUC,MAAM,CAACP,MAAjB,EACD,CACF,CAED,MAAO,KAAP,CACD,CAED,QAASS,CAAAA,OAAT,CAAiBC,MAAjB,CAA8B,CAC5B,QAASC,CAAAA,cAAT,EAA0B,CACxB,KAAMC,CAAAA,WAAW,CAAGf,eAAe,CAACa,MAAM,CAACG,KAAP,CAAab,MAAd,CAAnC,CAEA,GAAI,CAACY,WAAL,CAAkB,CAChB,OACD,CAED;AACAA,WAAW,CAACE,SAAZ,CAAsBC,aAAtB,CAAsC,IAAtC,CACD,CAED,GAAIjC,UAAJ,CAAgB,CACd4B,MAAM,CAACjB,KAAP,CAAauB,aAAb,CAA2BrB,GAA3B,CAA+BR,WAA/B,CAA6C8B,UAAD,EAAqB,oBAC/D,GAAI,CAAAA,UAAU,MAAV,wBAAAA,UAAU,CAAEC,EAAZ,8BAAgBC,IAAhB,IAAyBC,qCAA7B,CAAyD,CACvDT,cAAc,GACf,CACF,CAJD,EAKA,OACD,CAEDD,MAAM,CAACjB,KAAP,CAAa4B,cAAb,CACGC,GADH,CACOF,qCADP,EAEGzB,GAFH,CAEOR,WAFP,CAEoBwB,cAFpB,EAGD,CAEDf,mBAAmB,CAACH,KAApB,CAA0BiB,MAA1B,CACGY,GADH,CACO,iBADP,EAEG3B,GAFH,CAEOR,WAFP,CAEoBsB,OAFpB,EAIAb,mBAAmB,CAACH,KAApB,CAA0BiB,MAA1B,CACGY,GADH,CACO,gBADP,EAEG3B,GAFH,CAEOR,WAFP,CAEoBsB,OAFpB,EAIAb,mBAAmB,CAACH,KAApB,CAA0BiB,MAA1B,CACGY,GADH,CACO,oBADP,EAEG3B,GAFH,CAEOR,WAFP,CAEoBsB,OAFpB,EAIA,GAAI,CAACxB,qBAAqB,CAACsC,GAAtB,CAA0B7B,WAA1B,CAAL,CAA6C,CAC3CT,qBAAqB,CAACuC,GAAtB,CAA0B9B,WAA1B,CAAuC,EAAvC,EACD,CAED,KAAM+B,CAAAA,sBAAsB,CAAGxC,qBAAqB,CAACyC,GAAtB,CAC7BhC,WAD6B,CAA/B,CAIAA,WAAW,CAACD,KAAZ,CAAkBkC,IAAlB,CAAuBhC,GAAvB,CAA2BR,WAA3B,CAAwC,IAAM,CAC5C,GAAIL,UAAJ,CAAgB,CACd,IAAK,KAAM,CAACqC,IAAD,CAAOS,SAAP,CAAX,EAAgClC,CAAAA,WAAW,CAACmC,OAA5C,CAAqD,CACnD,IAAK,KAAMC,CAAAA,UAAX,GAAyBF,CAAAA,SAAS,CAACG,YAAnC,CAAiD,uBAC/C;AACA,KAAM/B,CAAAA,MAAM,CAAGN,WAAW,CAACQ,WAAZ,CAAwB8B,SAAxB,CAAkCF,UAAlC,CAAf,CACA,GAAI9B,MAAJ,2BAAIA,MAAM,CAAEc,SAAZ,SAAI,kBAAmBC,aAAvB,CAAsC,CACpCU,sBAAsB,CAACQ,IAAvB,CAA4Bd,IAA5B,EACA;AACAzB,WAAW,CAACmC,OAAZ,CAAoBK,MAApB,CAA2Bf,IAA3B,EACD,CACF,CACF,CACD,OACD,CACD;AACA;AACA,IACE,GAAIgB,CAAAA,CAAC,CAAGzC,WAAW,CAAC0C,oBAAZ,CAAiCC,MAAjC,CAA0C,CADpD,CAEEF,CAAC,EAAI,CAFP,CAGEA,CAAC,EAHH,CAIE,8CACA,KAAMG,CAAAA,UAAU,CAAG5C,WAAW,CAAC0C,oBAAZ,CAAiCD,CAAjC,CAAnB,CACA,GAAIG,UAAJ,4BAAIA,UAAU,CAAEtC,MAAhB,gCAAI,mBAAoBc,SAAxB,SAAI,sBAA+BC,aAAnC,CAAkD,CAChDU,sBAAsB,CAACQ,IAAvB,CAA4BK,UAAU,CAACnB,IAAvC,EACAzB,WAAW,CAAC0C,oBAAZ,CAAiCG,MAAjC,CAAwCJ,CAAxC,CAA2C,CAA3C,EACD,CACF,CAED,IAAK,GAAIA,CAAAA,CAAC,CAAGzC,WAAW,CAACmC,OAAZ,CAAoBQ,MAApB,CAA6B,CAA1C,CAA6CF,CAAC,EAAI,CAAlD,CAAqDA,CAAC,EAAtD,CAA0D,2BACxD,KAAMvB,CAAAA,WAAW,CAAGlB,WAAW,CAACmC,OAAZ,CAAoBM,CAApB,CAApB,CACA,GAAIvB,WAAJ,+BAAIA,WAAW,CAAEE,SAAjB,SAAI,sBAAwBC,aAA5B,CAA2C,CACzCrB,WAAW,CAACmC,OAAZ,CAAoBU,MAApB,CAA2BJ,CAA3B,CAA8B,CAA9B,EACD,CACF,CACF,CAnCD,EAoCD,CA/GH,EAiHD,CArH2C,C","sourcesContent":["import {\n  Compiler,\n  compilation as CompilationType,\n  Plugin,\n  version,\n} from 'webpack'\nimport { STRING_LITERAL_DROP_BUNDLE } from '../../../next-server/lib/constants'\n\nconst isWebpack5 = parseInt(version!) === 5\n\nexport const ampFirstEntryNamesMap: WeakMap<\n  CompilationType.Compilation,\n  string[]\n> = new WeakMap()\n\nconst PLUGIN_NAME = 'DropAmpFirstPagesPlugin'\n\n// Prevents outputting client pages when they are not needed\nexport class DropClientPage implements Plugin {\n  ampPages = new Set()\n\n  apply(compiler: Compiler) {\n    compiler.hooks.compilation.tap(\n      PLUGIN_NAME,\n      (compilation: any, { normalModuleFactory }: any) => {\n        // Recursively look up the issuer till it ends up at the root\n        function findEntryModule(mod: any): CompilationType.Module | null {\n          const queue = new Set([mod])\n          for (const module of queue) {\n            if (isWebpack5) {\n              // @ts-ignore TODO: webpack 5 types\n              const incomingConnections = compilation.moduleGraph.getIncomingConnections(\n                module\n              )\n\n              for (const incomingConnection of incomingConnections) {\n                if (!incomingConnection.originModule) return module\n                queue.add(incomingConnection.originModule)\n              }\n              continue\n            }\n\n            for (const reason of module.reasons) {\n              if (!reason.module) return module\n              queue.add(reason.module)\n            }\n          }\n\n          return null\n        }\n\n        function handler(parser: any) {\n          function markAsAmpFirst() {\n            const entryModule = findEntryModule(parser.state.module)\n\n            if (!entryModule) {\n              return\n            }\n\n            // @ts-ignore buildInfo exists on Module\n            entryModule.buildInfo.NEXT_ampFirst = true\n          }\n\n          if (isWebpack5) {\n            parser.hooks.preDeclarator.tap(PLUGIN_NAME, (declarator: any) => {\n              if (declarator?.id?.name === STRING_LITERAL_DROP_BUNDLE) {\n                markAsAmpFirst()\n              }\n            })\n            return\n          }\n\n          parser.hooks.varDeclaration\n            .for(STRING_LITERAL_DROP_BUNDLE)\n            .tap(PLUGIN_NAME, markAsAmpFirst)\n        }\n\n        normalModuleFactory.hooks.parser\n          .for('javascript/auto')\n          .tap(PLUGIN_NAME, handler)\n\n        normalModuleFactory.hooks.parser\n          .for('javascript/esm')\n          .tap(PLUGIN_NAME, handler)\n\n        normalModuleFactory.hooks.parser\n          .for('javascript/dynamic')\n          .tap(PLUGIN_NAME, handler)\n\n        if (!ampFirstEntryNamesMap.has(compilation)) {\n          ampFirstEntryNamesMap.set(compilation, [])\n        }\n\n        const ampFirstEntryNamesItem = ampFirstEntryNamesMap.get(\n          compilation\n        ) as string[]\n\n        compilation.hooks.seal.tap(PLUGIN_NAME, () => {\n          if (isWebpack5) {\n            for (const [name, entryData] of compilation.entries) {\n              for (const dependency of entryData.dependencies) {\n                // @ts-ignore TODO: webpack 5 types\n                const module = compilation.moduleGraph.getModule(dependency)\n                if (module?.buildInfo?.NEXT_ampFirst) {\n                  ampFirstEntryNamesItem.push(name)\n                  // @ts-ignore @types/webpack has outdated types for webpack 5\n                  compilation.entries.delete(name)\n                }\n              }\n            }\n            return\n          }\n          // Remove preparedEntrypoint that has bundle drop marker\n          // This will ensure webpack does not create chunks/bundles for this particular entrypoint\n          for (\n            let i = compilation._preparedEntrypoints.length - 1;\n            i >= 0;\n            i--\n          ) {\n            const entrypoint = compilation._preparedEntrypoints[i]\n            if (entrypoint?.module?.buildInfo?.NEXT_ampFirst) {\n              ampFirstEntryNamesItem.push(entrypoint.name)\n              compilation._preparedEntrypoints.splice(i, 1)\n            }\n          }\n\n          for (let i = compilation.entries.length - 1; i >= 0; i--) {\n            const entryModule = compilation.entries[i]\n            if (entryModule?.buildInfo?.NEXT_ampFirst) {\n              compilation.entries.splice(i, 1)\n            }\n          }\n        })\n      }\n    )\n  }\n}\n"]}