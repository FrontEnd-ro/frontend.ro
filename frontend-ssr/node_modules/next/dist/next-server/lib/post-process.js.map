{"version":3,"sources":["../../../next-server/lib/post-process.ts"],"names":["MIDDLEWARE_TIME_BUDGET","parseInt","process","env","__POST_PROCESS_MIDDLEWARE_TIME_BUDGET","MAXIMUM_IMAGE_PRELOADS","IMAGE_PRELOAD_SIZE_THRESHOLD","middlewareRegistry","registerPostProcessor","name","middleware","condition","push","processHTML","html","data","options","postProcessData","preloads","images","root","document","callMiddleWare","timer","Date","now","inspect","inspectTime","mutate","console","warn","i","length","FontOptimizerMiddleware","fontDefinitions","markup","_data","result","getFontDefinition","key","url","fallBackLinkTag","indexOf","fontContent","replace","originalDom","querySelectorAll","filter","tag","getAttribute","hasAttribute","OPTIMIZED_FONT_PROVIDERS","some","dataHref","startsWith","forEach","element","ImageOptimizerMiddleware","imagePreloadTags","imgHref","preloadTagAlreadyExists","reduce","acc","imgElements","eligibleImages","isImgEligible","imgEl","src","imgElement","imgSrc","sourceIsSupportedType","imageIsNotTooSmall","imageIsNotHidden","href","regex","RegExp","match","heightAttr","widthAttr","err","activeElement","parentNode","includes","optimizeFonts","__NEXT_OPTIMIZE_FONTS","optimizeImages","__NEXT_OPTIMIZE_IMAGES"],"mappings":"4DAAA,gDACA,sCAEA,KAAMA,CAAAA,sBAAsB,CAC1BC,QAAQ,CAACC,OAAO,CAACC,GAAR,CAAYC,qCAAZ,EAAqD,EAAtD,CAA0D,EAA1D,CAAR,EAAyE,EAD3E,CAEA,KAAMC,CAAAA,sBAAsB,CAAG,CAA/B,CACA,KAAMC,CAAAA,4BAA4B,CAAG,IAArC,CAoCA,KAAMC,CAAAA,kBAA8C,CAAG,EAAvD,CAEA,QAASC,CAAAA,qBAAT,CACEC,IADF,CAEEC,UAFF,CAGEC,SAHF,CAIE,CACAJ,kBAAkB,CAACK,IAAnB,CAAwB,CAAEH,IAAF,CAAQC,UAAR,CAAoBC,SAAS,CAAEA,SAAS,EAAI,IAA5C,CAAxB,EACD,CAED,cAAeE,CAAAA,WAAf,CACEC,IADF,CAEEC,IAFF,CAGEC,OAHF,CAImB,CACjB;AACA,GAAI,CAACT,kBAAkB,CAAC,CAAD,CAAvB,CAA4B,CAC1B,MAAOO,CAAAA,IAAP,CACD,CACD,KAAMG,CAAAA,eAAgC,CAAG,CACvCC,QAAQ,CAAE,CACRC,MAAM,CAAE,EADA,CAD6B,CAAzC,CAKA,KAAMC,CAAAA,IAAiB,CAAG,0BAAMN,IAAN,CAA1B,CACA,GAAIO,CAAAA,QAAQ,CAAGP,IAAf,CACA;AACA,cAAeQ,CAAAA,cAAf,CACEZ,UADF,CAEED,IAFF,CAGE,CACA,GAAIc,CAAAA,KAAK,CAAGC,IAAI,CAACC,GAAL,EAAZ,CACAf,UAAU,CAACgB,OAAX,CAAmBN,IAAnB,CAAyBH,eAAzB,CAA0CF,IAA1C,EACA,KAAMY,CAAAA,WAAW,CAAGH,IAAI,CAACC,GAAL,GAAaF,KAAjC,CACAF,QAAQ,CAAG,KAAMX,CAAAA,UAAU,CAACkB,MAAX,CAAkBP,QAAlB,CAA4BJ,eAA5B,CAA6CF,IAA7C,CAAjB,CACAQ,KAAK,CAAGC,IAAI,CAACC,GAAL,GAAaF,KAArB,CACA,GAAIA,KAAK,CAAGvB,sBAAZ,CAAoC,CAClC6B,OAAO,CAACC,IAAR,CACG,+BAA8BrB,IAAK,UAASc,KAAM,MAAKI,WAAY,KAClEJ,KAAK,CAAGI,WACT,0CAAyC3B,sBAAuB,SAHnE,EAKD,CACD,OACD,CAED,IAAK,GAAI+B,CAAAA,CAAC,CAAG,CAAb,CAAgBA,CAAC,CAAGxB,kBAAkB,CAACyB,MAAvC,CAA+CD,CAAC,EAAhD,CAAoD,CAClD,GAAIrB,CAAAA,UAAU,CAAGH,kBAAkB,CAACwB,CAAD,CAAnC,CACA,GAAI,CAACrB,UAAU,CAACC,SAAZ,EAAyBD,UAAU,CAACC,SAAX,CAAqBK,OAArB,CAA7B,CAA4D,CAC1D,KAAMM,CAAAA,cAAc,CAClBf,kBAAkB,CAACwB,CAAD,CAAlB,CAAsBrB,UADJ,CAElBH,kBAAkB,CAACwB,CAAD,CAAlB,CAAsBtB,IAFJ,CAApB,CAID,CACF,CAED,MAAOY,CAAAA,QAAP,CACD,CAED,KAAMY,CAAAA,uBAAyD,oBAC7DC,eAD6D,CAC5B,EAD4B,MA6B7DN,MA7B6D,CA6BpD,MACPO,MADO,CAEPC,KAFO,CAGPpB,OAHO,GAIJ,CACH,GAAIqB,CAAAA,MAAM,CAAGF,MAAb,CACA,GAAI,CAACnB,OAAO,CAACsB,iBAAb,CAAgC,CAC9B,MAAOH,CAAAA,MAAP,CACD,CACD,IAAK,KAAMI,CAAAA,GAAX,GAAkB,MAAKL,eAAvB,CAAwC,CACtC,KAAMM,CAAAA,GAAG,CAAG,KAAKN,eAAL,CAAqBK,GAArB,CAAZ,CACA,KAAME,CAAAA,eAAe,CAAI,gCAA+BD,GAAI,KAA5D,CACA,GACEH,MAAM,CAACK,OAAP,CAAgB,qBAAoBF,GAAI,IAAxC,EAA+C,CAAC,CAAhD,EACAH,MAAM,CAACK,OAAP,CAAeD,eAAf,EAAkC,CAAC,CAFrC,CAGE,CACA;AACA,SACD,CACD,KAAME,CAAAA,WAAW,CAAG3B,OAAO,CAACsB,iBAAR,CAA0BE,GAA1B,CAApB,CACA,GAAI,CAACG,WAAL,CAAkB,CAChB;AACR;AACA,WACQN,MAAM,CAAGA,MAAM,CAACO,OAAP,CAAe,SAAf,CAA2B,GAAEH,eAAgB,SAA7C,CAAT,CACD,CALD,IAKO,CACLJ,MAAM,CAAGA,MAAM,CAACO,OAAP,CACP,SADO,CAEN,qBAAoBJ,GAAI,KAAIG,WAAY,iBAFlC,CAAT,CAID,CACF,CACD,MAAON,CAAAA,MAAP,CACD,CA9D4D,EAE7DX,OAAO,CACLmB,WADK,CAELT,KAFK,CAGLpB,OAHK,CAIL,CACA,GAAI,CAACA,OAAO,CAACsB,iBAAb,CAAgC,CAC9B,OACD,CACD;AACAO,WAAW,CACRC,gBADH,CACoB,MADpB,EAEGC,MAFH,CAGKC,GAAD,EACEA,GAAG,CAACC,YAAJ,CAAiB,KAAjB,IAA4B,YAA5B,EACAD,GAAG,CAACE,YAAJ,CAAiB,WAAjB,CADA,EAEAC,oCAAyBC,IAAzB,CAA+BZ,GAAD,EAAS,CACrC,KAAMa,CAAAA,QAAQ,CAAGL,GAAG,CAACC,YAAJ,CAAiB,WAAjB,CAAjB,CACA,MAAOI,CAAAA,QAAQ,CAAGA,QAAQ,CAACC,UAAT,CAAoBd,GAApB,CAAH,CAA8B,KAA7C,CACD,CAHD,CANN,EAWGe,OAXH,CAWYC,OAAD,EAA0B,CACjC,KAAMhB,CAAAA,GAAG,CAAGgB,OAAO,CAACP,YAAR,CAAqB,WAArB,CAAZ,CACA,GAAIT,GAAJ,CAAS,CACP,KAAKN,eAAL,CAAqBtB,IAArB,CAA0B4B,GAA1B,EACD,CACF,CAhBH,EAiBD,CA5B4D,CAiE/D,KAAMiB,CAAAA,wBAA0D,oBAsB9D7B,MAtB8D,CAsBrD,MAAOO,MAAP,CAAuBC,KAAvB,GAAkD,CACzD,GAAIC,CAAAA,MAAM,CAAGF,MAAb,CACA,GAAIuB,CAAAA,gBAAgB,CAAGtB,KAAK,CAAClB,QAAN,CAAeC,MAAf,CACpB4B,MADoB,CACZY,OAAD,EAAa,CAACC,uBAAuB,CAACzB,MAAD,CAASwB,OAAT,CADxB,EAEpBE,MAFoB,CAGnB,CAACC,GAAD,CAAMH,OAAN,GACEG,GAAG,CAAI,6BAA4BH,OAAQ,gBAJ1B,CAKnB,EALmB,CAAvB,CAOA,MAAOtB,CAAAA,MAAM,CAACO,OAAP,CACL,qBADK,CAEJ,GAAEc,gBAAiB,qBAFf,CAAP,CAID,CAnC6D,EAC9DhC,OAAO,CAACmB,WAAD,CAA2BT,KAA3B,CAAmD,CACxD,KAAM2B,CAAAA,WAAW,CAAGlB,WAAW,CAACC,gBAAZ,CAA6B,KAA7B,CAApB,CACA,GAAIkB,CAAAA,cAAkC,CAAG,EAAzC,CACA,IAAK,GAAIjC,CAAAA,CAAC,CAAG,CAAb,CAAgBA,CAAC,CAAGgC,WAAW,CAAC/B,MAAhC,CAAwCD,CAAC,EAAzC,CAA6C,CAC3C,GAAIkC,aAAa,CAACF,WAAW,CAAChC,CAAD,CAAZ,CAAjB,CAAmC,CACjCiC,cAAc,CAACpD,IAAf,CAAoBmD,WAAW,CAAChC,CAAD,CAA/B,EACD,CACD,GAAIiC,cAAc,CAAChC,MAAf,EAAyB3B,sBAA7B,CAAqD,CACnD,MACD,CACF,CAED+B,KAAK,CAAClB,QAAN,CAAeC,MAAf,CAAwB,EAAxB,CAEA,IAAK,KAAM+C,CAAAA,KAAX,GAAoBF,CAAAA,cAApB,CAAoC,CAClC,KAAMG,CAAAA,GAAG,CAAGD,KAAK,CAACjB,YAAN,CAAmB,KAAnB,CAAZ,CACA,GAAIkB,GAAJ,CAAS,CACP/B,KAAK,CAAClB,QAAN,CAAeC,MAAf,CAAsBP,IAAtB,CAA2BuD,GAA3B,EACD,CACF,CACF,CArB6D,CAsChE,QAASF,CAAAA,aAAT,CAAuBG,UAAvB,CAAyD,CACvD,GAAIC,CAAAA,MAAM,CAAGD,UAAU,CAACnB,YAAX,CAAwB,KAAxB,CAAb,CACA,MACE,CAAC,CAACoB,MAAF,EACAC,qBAAqB,CAACD,MAAD,CADrB,EAEAE,kBAAkB,CAACH,UAAD,CAFlB,EAGAI,gBAAgB,CAACJ,UAAD,CAJlB,CAMD,CAED,QAASR,CAAAA,uBAAT,CAAiC9C,IAAjC,CAA+C2D,IAA/C,CAA6D,CAC3D,KAAMC,CAAAA,KAAK,CAAG,GAAIC,CAAAA,MAAJ,CAAY,sBAAqBF,IAAK,EAAtC,CAAd,CACA,MAAO3D,CAAAA,IAAI,CAAC8D,KAAL,CAAWF,KAAX,CAAP,CACD,CAED,QAASH,CAAAA,kBAAT,CAA4BH,UAA5B,CAA8D,CAC5D;AACA;AACA,GACE,EAAEA,UAAU,CAAClB,YAAX,CAAwB,QAAxB,GAAqCkB,UAAU,CAAClB,YAAX,CAAwB,OAAxB,CAAvC,CADF,CAEE,CACA,MAAO,KAAP,CACD,CACD,GAAI,CACF,KAAM2B,CAAAA,UAAU,CAAGT,UAAU,CAACnB,YAAX,CAAwB,QAAxB,CAAnB,CACA,KAAM6B,CAAAA,SAAS,CAAGV,UAAU,CAACnB,YAAX,CAAwB,OAAxB,CAAlB,CACA,GAAI,CAAC4B,UAAD,EAAe,CAACC,SAApB,CAA+B,CAC7B,MAAO,KAAP,CACD,CAED,GACE7E,QAAQ,CAAC4E,UAAD,CAAR,CAAuB5E,QAAQ,CAAC6E,SAAD,CAA/B,EACAxE,4BAFF,CAGE,CACA,MAAO,MAAP,CACD,CACF,CAAC,MAAOyE,GAAP,CAAY,CACZ,MAAO,KAAP,CACD,CACD,MAAO,KAAP,CACD,CAED;AACA;AACA,QAASP,CAAAA,gBAAT,CAA0BJ,UAA1B,CAA4D,CAC1D,GAAIY,CAAAA,aAAa,CAAGZ,UAApB,CACA,MAAOY,aAAa,CAACC,UAArB,CAAiC,CAC/B,GAAID,aAAa,CAAC9B,YAAd,CAA2B,QAA3B,CAAJ,CAA0C,CACxC,MAAO,MAAP,CACD,CACD8B,aAAa,CAAGA,aAAa,CAACC,UAA9B,CACD,CACD,MAAO,KAAP,CACD,CAED;AACA,QAASX,CAAAA,qBAAT,CAA+BD,MAA/B,CAAwD,CACtD,MAAO,CAACA,MAAM,CAACa,QAAP,CAAgB,MAAhB,CAAR,CACD,CAED;AACA1E,qBAAqB,CACnB,cADmB,CAEnB,GAAIyB,CAAAA,uBAAJ,EAFmB,CAGnB;AACA;AACCjB,OAAD,EAAaA,OAAO,CAACmE,aAAR,EAAyBjF,OAAO,CAACC,GAAR,CAAYiF,qBAL/B,CAArB,CAQA5E,qBAAqB,CACnB,gBADmB,CAEnB,GAAIiD,CAAAA,wBAAJ,EAFmB,CAGnB;AACCzC,OAAD,EAAaA,OAAO,CAACqE,cAAR,EAA0BnF,OAAO,CAACC,GAAR,CAAYmF,sBAJhC,CAArB,C,aAOezE,W","sourcesContent":["import { parse, HTMLElement } from 'node-html-parser'\nimport { OPTIMIZED_FONT_PROVIDERS } from './constants'\n\nconst MIDDLEWARE_TIME_BUDGET =\n  parseInt(process.env.__POST_PROCESS_MIDDLEWARE_TIME_BUDGET || '', 10) || 10\nconst MAXIMUM_IMAGE_PRELOADS = 2\nconst IMAGE_PRELOAD_SIZE_THRESHOLD = 2500\n\ntype postProcessOptions = {\n  optimizeFonts: boolean\n  optimizeImages: boolean\n}\n\ntype renderOptions = {\n  getFontDefinition?: (url: string) => string\n}\n\ntype postProcessData = {\n  preloads: {\n    images: Array<string>\n  }\n}\n\ninterface PostProcessMiddleware {\n  inspect: (\n    originalDom: HTMLElement,\n    data: postProcessData,\n    options: renderOptions\n  ) => void\n  mutate: (\n    markup: string,\n    data: postProcessData,\n    options: renderOptions\n  ) => Promise<string>\n}\n\ntype middlewareSignature = {\n  name: string\n  middleware: PostProcessMiddleware\n  condition: ((options: postProcessOptions) => boolean) | null\n}\n\nconst middlewareRegistry: Array<middlewareSignature> = []\n\nfunction registerPostProcessor(\n  name: string,\n  middleware: PostProcessMiddleware,\n  condition?: (options: postProcessOptions) => boolean\n) {\n  middlewareRegistry.push({ name, middleware, condition: condition || null })\n}\n\nasync function processHTML(\n  html: string,\n  data: renderOptions,\n  options: postProcessOptions\n): Promise<string> {\n  // Don't parse unless there's at least one processor middleware\n  if (!middlewareRegistry[0]) {\n    return html\n  }\n  const postProcessData: postProcessData = {\n    preloads: {\n      images: [],\n    },\n  }\n  const root: HTMLElement = parse(html)\n  let document = html\n  // Calls the middleware, with some instrumentation and logging\n  async function callMiddleWare(\n    middleware: PostProcessMiddleware,\n    name: string\n  ) {\n    let timer = Date.now()\n    middleware.inspect(root, postProcessData, data)\n    const inspectTime = Date.now() - timer\n    document = await middleware.mutate(document, postProcessData, data)\n    timer = Date.now() - timer\n    if (timer > MIDDLEWARE_TIME_BUDGET) {\n      console.warn(\n        `The postprocess middleware \"${name}\" took ${timer}ms(${inspectTime}, ${\n          timer - inspectTime\n        }) to complete. This is longer than the ${MIDDLEWARE_TIME_BUDGET} limit.`\n      )\n    }\n    return\n  }\n\n  for (let i = 0; i < middlewareRegistry.length; i++) {\n    let middleware = middlewareRegistry[i]\n    if (!middleware.condition || middleware.condition(options)) {\n      await callMiddleWare(\n        middlewareRegistry[i].middleware,\n        middlewareRegistry[i].name\n      )\n    }\n  }\n\n  return document\n}\n\nclass FontOptimizerMiddleware implements PostProcessMiddleware {\n  fontDefinitions: Array<string> = []\n  inspect(\n    originalDom: HTMLElement,\n    _data: postProcessData,\n    options: renderOptions\n  ) {\n    if (!options.getFontDefinition) {\n      return\n    }\n    // collecting all the requested font definitions\n    originalDom\n      .querySelectorAll('link')\n      .filter(\n        (tag: HTMLElement) =>\n          tag.getAttribute('rel') === 'stylesheet' &&\n          tag.hasAttribute('data-href') &&\n          OPTIMIZED_FONT_PROVIDERS.some((url) => {\n            const dataHref = tag.getAttribute('data-href')\n            return dataHref ? dataHref.startsWith(url) : false\n          })\n      )\n      .forEach((element: HTMLElement) => {\n        const url = element.getAttribute('data-href')\n        if (url) {\n          this.fontDefinitions.push(url)\n        }\n      })\n  }\n  mutate = async (\n    markup: string,\n    _data: postProcessData,\n    options: renderOptions\n  ) => {\n    let result = markup\n    if (!options.getFontDefinition) {\n      return markup\n    }\n    for (const key in this.fontDefinitions) {\n      const url = this.fontDefinitions[key]\n      const fallBackLinkTag = `<link rel=\"stylesheet\" href=\"${url}\"/>`\n      if (\n        result.indexOf(`<style data-href=\"${url}\">`) > -1 ||\n        result.indexOf(fallBackLinkTag) > -1\n      ) {\n        // The font is already optimized and probably the response is cached\n        continue\n      }\n      const fontContent = options.getFontDefinition(url)\n      if (!fontContent) {\n        /**\n         * In case of unreachable font definitions, fallback to default link tag.\n         */\n        result = result.replace('</head>', `${fallBackLinkTag}</head>`)\n      } else {\n        result = result.replace(\n          '</head>',\n          `<style data-href=\"${url}\">${fontContent}</style></head>`\n        )\n      }\n    }\n    return result\n  }\n}\n\nclass ImageOptimizerMiddleware implements PostProcessMiddleware {\n  inspect(originalDom: HTMLElement, _data: postProcessData) {\n    const imgElements = originalDom.querySelectorAll('img')\n    let eligibleImages: Array<HTMLElement> = []\n    for (let i = 0; i < imgElements.length; i++) {\n      if (isImgEligible(imgElements[i])) {\n        eligibleImages.push(imgElements[i])\n      }\n      if (eligibleImages.length >= MAXIMUM_IMAGE_PRELOADS) {\n        break\n      }\n    }\n\n    _data.preloads.images = []\n\n    for (const imgEl of eligibleImages) {\n      const src = imgEl.getAttribute('src')\n      if (src) {\n        _data.preloads.images.push(src)\n      }\n    }\n  }\n  mutate = async (markup: string, _data: postProcessData) => {\n    let result = markup\n    let imagePreloadTags = _data.preloads.images\n      .filter((imgHref) => !preloadTagAlreadyExists(markup, imgHref))\n      .reduce(\n        (acc, imgHref) =>\n          acc + `<link rel=\"preload\" href=\"${imgHref}\" as=\"image\"/>`,\n        ''\n      )\n    return result.replace(\n      /<link rel=\"preload\"/,\n      `${imagePreloadTags}<link rel=\"preload\"`\n    )\n  }\n}\n\nfunction isImgEligible(imgElement: HTMLElement): boolean {\n  let imgSrc = imgElement.getAttribute('src')\n  return (\n    !!imgSrc &&\n    sourceIsSupportedType(imgSrc) &&\n    imageIsNotTooSmall(imgElement) &&\n    imageIsNotHidden(imgElement)\n  )\n}\n\nfunction preloadTagAlreadyExists(html: string, href: string) {\n  const regex = new RegExp(`<link[^>]*href[^>]*${href}`)\n  return html.match(regex)\n}\n\nfunction imageIsNotTooSmall(imgElement: HTMLElement): boolean {\n  // Skip images without both height and width--we don't know enough to say if\n  // they are too small\n  if (\n    !(imgElement.hasAttribute('height') && imgElement.hasAttribute('width'))\n  ) {\n    return true\n  }\n  try {\n    const heightAttr = imgElement.getAttribute('height')\n    const widthAttr = imgElement.getAttribute('width')\n    if (!heightAttr || !widthAttr) {\n      return true\n    }\n\n    if (\n      parseInt(heightAttr) * parseInt(widthAttr) <=\n      IMAGE_PRELOAD_SIZE_THRESHOLD\n    ) {\n      return false\n    }\n  } catch (err) {\n    return true\n  }\n  return true\n}\n\n// Traverse up the dom from each image to see if it or any of it's\n// ancestors have the hidden attribute.\nfunction imageIsNotHidden(imgElement: HTMLElement): boolean {\n  let activeElement = imgElement\n  while (activeElement.parentNode) {\n    if (activeElement.hasAttribute('hidden')) {\n      return false\n    }\n    activeElement = activeElement.parentNode as HTMLElement\n  }\n  return true\n}\n\n// Currently only filters out svg images--could be made more specific in the future.\nfunction sourceIsSupportedType(imgSrc: string): boolean {\n  return !imgSrc.includes('.svg')\n}\n\n// Initialization\nregisterPostProcessor(\n  'Inline-Fonts',\n  new FontOptimizerMiddleware(),\n  // Using process.env because passing Experimental flag through loader is not possible.\n  // @ts-ignore\n  (options) => options.optimizeFonts || process.env.__NEXT_OPTIMIZE_FONTS\n)\n\nregisterPostProcessor(\n  'Preload Images',\n  new ImageOptimizerMiddleware(),\n  // @ts-ignore\n  (options) => options.optimizeImages || process.env.__NEXT_OPTIMIZE_IMAGES\n)\n\nexport default processHTML\n"]}